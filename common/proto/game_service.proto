syntax = "proto3";

package game_service;

import "snake.proto";
import "tictactoe.proto";

service GameService {
    rpc GameStream(stream ClientMessage) returns (stream ServerMessage);
}

message ClientMessage {
    string version = 1;

    oneof message {
        ConnectRequest connect = 10;
        DisconnectRequest disconnect = 11;
        ListLobbiesRequest list_lobbies = 12;
        CreateLobbyRequest create_lobby = 13;
        JoinLobbyRequest join_lobby = 14;
        LeaveLobbyRequest leave_lobby = 15;
        MarkReadyRequest mark_ready = 16;
        StartGameRequest start_game = 17;
        PlayAgainRequest play_again = 18;
        AddBotRequest add_bot = 19;
        KickFromLobbyRequest kick_from_lobby = 20;
        LobbyListChatMessage lobby_list_chat = 21;
        InLobbyChatMessage in_lobby_chat = 22;
        PingRequest ping = 23;

        BecomeObserverFromPlayerRequest become_observer = 30;
        BecomePlayerFromObserverRequest become_player = 31;
        MakePlayerObserverRequest make_observer = 32;

        InGameCommand in_game = 100;
    }
}

message ServerMessage {
    oneof message {
        ConnectResponse connect = 1;

        LobbyListResponse lobby_list = 10;
        LobbyCreatedNotification lobby_created = 11;
        LobbyJoinedNotification lobby_joined = 12;
        LobbyUpdateNotification lobby_update = 13;
        PlayerJoinedNotification player_joined = 14;
        PlayerLeftNotification player_left = 15;
        PlayerReadyNotification player_ready = 16;
        KickedFromLobbyNotification kicked = 17;
        ServerShuttingDownNotification shutdown = 18;
        PlayAgainStatusNotification play_again_status = 19;
        LobbyListChatNotification lobby_list_chat = 20;
        InLobbyChatNotification in_lobby_chat = 21;
        PongResponse pong = 22;
        LobbyListUpdateNotification lobby_list_update = 23;
        LobbyClosedNotification lobby_closed = 24;
        PlayerBecameObserverNotification player_became_observer = 25;
        ObserverBecamePlayerNotification observer_became_player = 26;

        GameStartingNotification game_starting = 100;
        GameStateUpdate game_state = 101;
        GameOverNotification game_over = 102;
        ReplayFileReadyNotification replay_file = 103;

        ErrorResponse error = 200;
    }
}

message ConnectRequest {
    string client_id = 1;
}

message ConnectResponse {
    bool success = 1;
}

message DisconnectRequest {}

enum ErrorCode {
    ERROR_CODE_UNSPECIFIED = 0;
    ERROR_CODE_VERSION_MISMATCH = 1;
    ERROR_CODE_GENERAL = 2;
}

message ErrorResponse {
    ErrorCode code = 1;
    string message = 2;
}

message ListLobbiesRequest {}

message LobbyListResponse {
    repeated LobbyInfo lobbies = 1;
}

message LobbySettings {
    oneof settings {
        snake.SnakeLobbySettings snake = 1;
        tictactoe.TicTacToeLobbySettings tictactoe = 2;
    }
}

message LobbyInfo {
    string lobby_id = 1;
    string lobby_name = 2;
    uint32 current_players = 3;
    uint32 max_players = 4;
    uint32 observer_count = 5;
    LobbySettings settings = 6;
}

message CreateLobbyRequest {
    string lobby_name = 1;
    uint32 max_players = 2;
    LobbySettings settings = 3;
}

message JoinLobbyRequest {
    string lobby_id = 1;
    bool join_as_observer = 2;
}

message LeaveLobbyRequest {}

message MarkReadyRequest {
    bool ready = 1;
}

message StartGameRequest {}

message PlayAgainRequest {}

message AddBotRequest {
    oneof bot_type {
        snake.SnakeBotType snake_bot = 1;
        tictactoe.TicTacToeBotType tictactoe_bot = 2;
    }
}

message KickFromLobbyRequest {
    string player_id = 1;
}

message BecomeObserverFromPlayerRequest {}

message BecomePlayerFromObserverRequest {}

message MakePlayerObserverRequest {
    string player_id = 1;
}

message PlayerBecameObserverNotification {
    PlayerIdentity player = 1;
}

message ObserverBecamePlayerNotification {
    PlayerIdentity observer = 1;
}

message LobbyListChatMessage {
    string message = 1;
}

message InLobbyChatMessage {
    string message = 1;
}

message PingRequest {
    uint64 ping_id = 1;
    uint64 client_timestamp_ms = 2;
}

message PongResponse {
    uint64 ping_id = 1;
    uint64 client_timestamp_ms = 2;
}

message InGameCommand {
    oneof command {
        snake.SnakeInGameCommand snake = 1;
        tictactoe.TicTacToeInGameCommand tictactoe = 2;
    }
}

message GameStateUpdate {
    oneof state {
        snake.SnakeGameState snake = 1;
        tictactoe.TicTacToeGameState tictactoe = 2;
    }
}

message PlayerIdentity {
    string player_id = 1;
    bool is_bot = 2;
}

message LobbyDetails {
    string lobby_id = 1;
    string lobby_name = 2;
    uint32 max_players = 3;
    repeated PlayerInfo players = 4;
    PlayerIdentity creator = 5;
    repeated PlayerIdentity observers = 6;
    oneof settings {
        snake.SnakeLobbySettings snake = 10;
        tictactoe.TicTacToeLobbySettings tictactoe = 11;
    }
}

message PlayerInfo {
    PlayerIdentity identity = 1;
    bool ready = 2;
}

message LobbyCreatedNotification {
    LobbyDetails details = 1;
}

message LobbyJoinedNotification {
    LobbyDetails details = 1;
}

message LobbyUpdateNotification {
    LobbyDetails details = 1;
}

message PlayerJoinedNotification {
    PlayerIdentity player = 1;
}

message PlayerLeftNotification {
    PlayerIdentity player = 1;
}

message PlayerReadyNotification {
    PlayerIdentity player = 1;
    bool ready = 2;
}

message GameStartingNotification {
    string session_id = 1;
}

message GameOverNotification {
    repeated ScoreEntry scores = 1;
    PlayerIdentity winner = 2;
    oneof game_info {
        snake.SnakeGameEndInfo snake_info = 10;
        tictactoe.TicTacToeGameEndInfo tictactoe_info = 11;
    }
}

message ScoreEntry {
    PlayerIdentity identity = 1;
    uint32 score = 2;
}

message KickedFromLobbyNotification {
    string reason = 1;
}

message ServerShuttingDownNotification {
    string message = 1;
}

message PlayAgainStatusNotification {
    repeated PlayerIdentity ready_players = 1;
    repeated PlayerIdentity pending_players = 2;
    bool available = 3;
}

message LobbyListChatNotification {
    PlayerIdentity sender = 1;
    string message = 2;
}

message InLobbyChatNotification {
    PlayerIdentity sender = 1;
    string message = 2;
}

message LobbyListUpdateNotification {}

message LobbyClosedNotification {
    string message = 1;
}

message ReplayFileReadyNotification {
    int32 version = 1;
    string suggested_file_name = 2;
    bytes content = 3;
}
